---
title: "Data Prep"
author: "Mykola Dereva"
date: "3/8/2021"
output: html_document
---


```{r}
rm(list = ls())

library(tidyverse)
library(here)
library(readxl)
```


Set locale to display Ukrainian characters properly
```{r}
Sys.setlocale("LC_CTYPE", "ukrainian")
```

Load main data related to companies cost structure
Data is obtained from ukrainian statistic service (ukrstat.gov.ua)
Data is formatted in a very interesting way so I expect a lot of work to make it 
tidy



```{r}
colnames <- str_c("col_", 1:28) 

data <- read_xlsx(path = here("Raw Data",
                              "Costs structure 2012-2019  +.xlsx"),
                  na = c("−", "к/с"), 
                  skip = 16, n_max = 7744, # specific to this file
                  col_names = colnames)

```


```{r}
tail(data)
```

Data have 2 levels of aggregation I think it will be safer to parse it with
one variable in time


fill name code and year to each row:
```{r}
data <- data %>% 
  fill(1:2,28, .direction = "down") %>% 
  na_if("к/с")  # read_xlsx did not changed it to NA
```




```{r}
clean <- data %>% 
  select(28, 2:7) %>% 
  rename( "group_name" = "col_28",
          "group_code" = "col_2",
          "year"       = "col_3",
          "large"      = "col_4",
          "medium"     = "col_5",
          "small"      = "col_6",
          "micro"      = "col_7") %>% 
  pivot_longer(cols = c("large", "medium", "small", "micro"),
               names_to = "firm_size", values_to = "total_cost") %>%
  fill(group_name, group_code, .direction = "down") %>% 
  mutate_at(c("total_cost"), as.numeric) %>% 
  mutate(year = as.integer(year))

  
head(clean)
```



Now we data starts to look tidy, but I have to join other variables of cost 
structure. 


Helper function to automate previous chunk

```{r}
extract_firms_var <- function(data,
                              group_code = "col_2",
                              year       = "col_3",
                              large, medium, small, micro,
                              var_name) {
  data %>% 
  select(group_code, year, large, medium, small, micro) %>% 
  rename( "group_code" = group_code,
          "year"       = year,
          "large"      = large,
          "medium"     = medium,
          "small"      = small,
          "micro"      = micro) %>%
  pivot_longer(cols = c("large", "medium", "small", "micro"),
               names_to = "firm_size", values_to = var_name) %>% 
  fill(group_code, .direction = "down") %>% 
  mutate_at(c(var_name), as.numeric) %>% 
  mutate(year = as.integer(year))

  
  }
                              
```


test function
```{r}
material_costs <- data %>% 
  extract_firms_var(large = "col_8", medium = "col_9",
                    small = "col_10", micro = "col_11",
                    var_name = "material_cost")

head(material_costs)
```
Seems to work fine

```{r}
amortisation <- data %>% 
  extract_firms_var(large = "col_12", medium = "col_13",
                    small = "col_14", micro = "col_15",
                    var_name = "amortisation_cost")

wages <- data %>% 
  extract_firms_var(large = "col_16", medium = "col_17",
                    small = "col_18", micro = "col_19",
                    var_name = "labour_cost")

soc_security <- data %>% 
  extract_firms_var(large = "col_20", medium = "col_21",
                    small = "col_22", micro = "col_23",
                    var_name = "social_security_cost")

other <- data %>% 
  extract_firms_var(large = "col_24", medium = "col_25",
                    small = "col_26", micro = "col_27",
                    var_name = "other_cost")
```



join to the clean dataset
```{r}
clean <- clean %>%
  left_join(material_costs) %>% 
  left_join(amortisation) %>% 
  left_join(wages) %>% 
  left_join(soc_security) %>% 
  left_join(other)

head(clean)
```


Check if the total cost equal sum of cost structure
```{r}
clean %>% 
  filter(year == 2015, firm_size == "medium") %>%
  group_by(group_code) %>% 
  mutate(sum_cost = sum(material_cost, amortisation_cost, labour_cost,
           social_security_cost, other_cost)) %>% 
  select(total_cost, sum_cost) %>% 
  head(10)
```
The numbers match. 


Load data related to revenues



```{r}
colnames <- str_c("c", 1:13) 

data <- read_xlsx(path = here("Raw Data",
                              "Production Value 2012-2019  +.xlsx"),
                  na = c("−", "к/с"),      # dont know why but this line doesnt works
                  skip = 13, n_max = 7744, # specific to this file
                  col_names = colnames)

```


```{r}
tail(data)
```



I dont know what exactly is this dash.
so I assign it
```{r}
(irritating_value <- data$c5[7700])
```

```{r}
data <- data %>% 
  fill("c2", .direction = "down") %>% 
  na_if("к/с") %>% # read_xlsx did not changed it to NA
  na_if(irritating_value)
```

Now NAs coded properly


```{r}
revenue <- data %>% 
  extract_firms_var(group_code = "c2", year = "c3",
                    large = "c5", medium = "c7",
                    small = "c9", micro = "c11",
                    var_name = "revenue")

head(revenue)
```


```{r}
clean <- clean %>%
  left_join(revenue)
```



The last part is the dataset reladed to the firms number


```{r}
colnames <- str_c("c", 1:32) 

data <- read_xlsx(path = here("Raw Data",
                              "Firms Number 2010-2019  +.xlsx"),
                  na = c(irritating_value),    
                  skip = 16, n_max = 9680, # specific to this file
                  col_names = colnames)
```

```{r}
tail(data)
```

```{r}
(irritating_value <-  data$c4[9680])
```

```{r}
data <- data %>% 
  fill("c2", .direction = "down") %>% 
  na_if(irritating_value)
```


```{r}
tail(data)
```



```{r}
firms_n <- data %>% 
  extract_firms_var(group_code = "c2", year = "c3",
                    large = "c4", medium = "c6",
                    small = "c8", micro = "c10",
                    var_name = "n_firms")
head(firms_n)
```

```{r}
clean <- clean %>%
  left_join(firms_n)
```

```{r}
head(clean)
```

